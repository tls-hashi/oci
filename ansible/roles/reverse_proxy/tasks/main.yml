- name: Install Podman and Certbot from APT (ARM64 compatible)
  apt:
    name:
      - podman
      - certbot
    state: present
    update_cache: true
  become: true

- name: Ensure nginx log directory exists on host
  file:
    path: /var/log/nginx
    state: directory
    mode: '0755'
  become: true

- name: Ensure /etc/nginx directory exists
  file:
    path: /etc/nginx
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Template nginx.conf
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: Restart nginx container
  become: true

- name: Run (or replace) nginx reverse proxy with Podman (with host network)
  become: true
  shell: |
    sudo podman run --replace -d --name nginx-proxy \
      --network host \
      -v /etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
      -v /var/log/nginx:/var/log/nginx \
      cgr.dev/chainguard/nginx \
      nginx -g "daemon off;" -c /etc/nginx/nginx.conf
  args:
    creates: /etc/systemd/system/container-nginx-proxy.service

- name: Wait until container is running using podman ps filter
  become: true
  block:
    - name: Wait until container is visible via podman ps
      shell: |
        sudo podman ps --filter name=nginx-proxy --format '{{"{{"}}.Names{{"}}"}}'
      register: podman_status
      retries: 8
      delay: 3
      until: podman_status.stdout.find('nginx-proxy') != -1
      changed_when: false
  rescue:
    - name: Print container logs for troubleshooting
      shell: sudo podman logs nginx-proxy
      register: container_logs
      ignore_errors: yes

    - name: Debug container logs
      debug:
        var: container_logs.stdout

    - name: Fail since container "nginx-proxy" is not running
      fail:
        msg: "Podman container nginx-proxy failed to start. Review container logs above."

- name: Wait until container state is running using podman inspect
  become: true
  block:
    - name: Check container state with podman inspect
      shell: |
        sudo podman inspect --format '{{"{{"}}.State.Status{{"}}"}}' nginx-proxy
      register: container_state
      retries: 10
      delay: 3
      until: container_state.stdout.strip() == "running"
      changed_when: false
  rescue:
    - name: Print full container inspect output for troubleshooting
      shell: sudo podman inspect nginx-proxy
      register: inspect_output
      ignore_errors: yes

    - name: Debug container inspect output
      debug:
        var: inspect_output.stdout

    - name: Fail since container "nginx-proxy" is not in running state
      fail:
        msg: "Podman container nginx-proxy is not running. Review inspect output for more details."

- name: Log Podman container status
  debug:
    msg: "Podman container 'nginx-proxy' is now running."

- name: Check if reverse proxy is serving on port 80
  wait_for:
    host: "127.0.0.1"
    port: 80
    timeout: 15


- name: Log reverse proxy status
  debug:
    msg: "Reverse proxy is serving on ports 80 and 443."

- name: Deploy updated nginx configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart nginx container
  become: true

- name: Pause to allow config write
  pause:
    seconds: 5

- name: Trigger restart of nginx container via handler
  meta: flush_handlers
