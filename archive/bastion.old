resource "oci_bastion_bastion" "bastion" {
  compartment_id = data.oci_identity_compartment.current.id
  name           = "twotwotwo-bastion"
  target_subnet_id = oci_core_subnet.bastion_subnet.id

  // Configure client CIDR restrictions if desired
  client_cidr_block_allow_list = ["0.0.0.0/0"] // Adjust this to restrict access to specific IPs or ranges

  // Set a maximum session duration (in seconds)
  max_session_ttl_in_seconds = 3600

  bastion_type = "STANDARD" // added required argument

}

resource "oci_core_subnet" "bastion_subnet" {
  compartment_id = data.oci_identity_compartment.current.id
  vcn_id         = var.vcn_ocid
  cidr_block     = "10.0.3.0/24"
  display_name   = "bastion-subnet"
  availability_domain = "PHX-AD-1" # Replace with your desired AD
  security_list_ids = [oci_core_network_security_group.bastion_nsg.id]
  route_table_id  = oci_core_default_route_table.default_route_table.id
  dhcp_options_id = oci_core_default_dhcp_options.default_dhcp_options.id
  prohibit_public_ip_on_vnic = false # Ensure instances in this subnet can have public IPs
}

resource "oci_core_network_security_group" "bastion_nsg" {
  compartment_id = data.oci_identity_compartment.current.id
  vcn_id         = data.oci_core_vcn.twotwotwo_vcn.vcn_id
  display_name   = "Bastion Network Security Group"
}

resource "oci_core_network_security_group_security_rule" "bastion_ingress_ssh" {
  network_security_group_id = oci_core_network_security_group.bastion_nsg.id
  direction                 = "INGRESS"
  protocol                  = "6" // TCP
  source                    = "0.0.0.0/0" // Adjust to restrict source IPs if needed
  source_type               = "CIDR_BLOCK"
  tcp_options {
    destination_port_range {
      min = 22
      max = 22
    }
  }
}

// Changed from data to resource for default route table
resource "oci_core_default_route_table" "default_route_table" {
  compartment_id = data.oci_identity_compartment.current.id
  manage_default_resource_id = data.oci_core_vcn.twotwotwo_vcn.default_route_table_id
}

// Changed from data to resource for default DHCP options
resource "oci_core_default_dhcp_options" "default_dhcp_options" {
  compartment_id             = data.oci_identity_compartment.current.id
  manage_default_resource_id = data.oci_core_vcn.twotwotwo_vcn.default_dhcp_options_id
  options {
    type        = "DomainNameServer"
    server_type = "VcnLocalPlusInternet" // added required argument
  }
}

// Added missing data blocks so that references resolve:
data "oci_identity_compartment" "current" {
  id = var.compartment_ocid
}

data "oci_core_vcn" "twotwotwo_vcn" {
  vcn_id = var.vcn_ocid
}

